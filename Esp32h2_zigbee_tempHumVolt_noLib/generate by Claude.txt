#include <Arduino.h>

// Définition des broches
#define DHT22_PIN 4        // GPIO pour DHT22
#define AM2302B_PIN 5      // GPIO pour AM2302B

// Structure pour stocker les données de température et humidité
struct SensorData {
  float temperature;
  float humidity;
  bool isValid;
};

/**
 * Lit les données d'un capteur DHT22 ou AM2302B sans bibliothèque externe
 * @param pin Numéro de la broche GPIO connectée au capteur
 * @return Structure SensorData contenant température, humidité et statut de validité
 */
SensorData lireCapteurDHT(uint8_t pin) {
  SensorData data;
  data.isValid = false;
  
  uint8_t bits[5] = {0}; // 40 bits de données (5 octets)
  uint8_t idx = 0;
  uint8_t bitIdx = 7;
  
  // Étape 1: Signal de démarrage - MCU tire la ligne BAS pendant au moins 1ms
  pinMode(pin, OUTPUT);
  digitalWrite(pin, LOW);
  delay(1);
  
  // Étape 2: MCU tire la ligne HAUT pendant 20-40µs
  digitalWrite(pin, HIGH);
  delayMicroseconds(30);
  
  // Étape 3: Passer en mode lecture
  pinMode(pin, INPUT_PULLUP);
  
  // Étape 4: Attendre la réponse du capteur (80µs LOW + 80µs HIGH)
  uint32_t timeout = micros();
  while(digitalRead(pin) == HIGH) {
    if((micros() - timeout) > 100) return data;
  }
  
  timeout = micros();
  while(digitalRead(pin) == LOW) {
    if((micros() - timeout) > 100) return data;
  }
  
  timeout = micros();
  while(digitalRead(pin) == HIGH) {
    if((micros() - timeout) > 100) return data;
  }
  
  // Étape 5: Lire les 40 bits de données
  for(int i = 0; i < 40; i++) {
    // Attendre le début du signal (50µs LOW)
    timeout = micros();
    while(digitalRead(pin) == LOW) {
      if((micros() - timeout) > 70) return data;
    }
    
    // Mesurer la durée du signal HIGH
    // Si HIGH dure ~26-28µs = bit 0
    // Si HIGH dure ~70µs = bit 1
    uint32_t startTime = micros();
    
    timeout = micros();
    while(digitalRead(pin) == HIGH) {
      if((micros() - timeout) > 90) return data;
    }
    
    uint32_t duration = micros() - startTime;
    
    // Si la durée > 40µs, c'est un bit 1
    if(duration > 40) {
      bits[idx] |= (1 << bitIdx);
    }
    
    if(bitIdx == 0) {
      bitIdx = 7;
      idx++;
    } else {
      bitIdx--;
    }
  }
  
  // Étape 6: Vérifier le checksum
  uint8_t checksum = bits[0] + bits[1] + bits[2] + bits[3];
  if(checksum != bits[4]) {
    return data;
  }
  
  // Étape 7: Calculer l'humidité et la température
  // DHT22/AM2302B: 16 bits humidité, 16 bits température
  uint16_t rawHumidity = (bits[0] << 8) | bits[1];
  uint16_t rawTemp = (bits[2] << 8) | bits[3];
  
  data.humidity = rawHumidity * 0.1;
  
  // Vérifier le bit de signe pour la température
  if(rawTemp & 0x8000) {
    rawTemp &= 0x7FFF;
    data.temperature = rawTemp * -0.1;
  } else {
    data.temperature = rawTemp * 0.1;
  }
  
  data.isValid = true;
  return data;
}

/**
 * Affiche les données d'un capteur
 */
void afficherDonnees(SensorData data, const char* nomCapteur) {
  if(!data.isValid) {
    Serial.print("Erreur de lecture du capteur ");
    Serial.println(nomCapteur);
    return;
  }
  
  Serial.println("=================================");
  Serial.print("Capteur: ");
  Serial.println(nomCapteur);
  Serial.print("Humidité: ");
  Serial.print(data.humidity, 1);
  Serial.println(" %");
  Serial.print("Température: ");
  Serial.print(data.temperature, 1);
  Serial.println(" °C");
  Serial.println("=================================");
}

void setup() {
  Serial.begin(115200);
  delay(2000);
  
  Serial.println("Initialisation des capteurs DHT22 et AM2302B...");
  Serial.println("Capteurs prêts !");
}

void loop() {
  // Lecture du DHT22
  SensorData dataDHT22 = lireCapteurDHT(DHT22_PIN);
  afficherDonnees(dataDHT22, "DHT22");
  
  delay(100); // Petit délai entre les deux lectures
  
  // Lecture du AM2302B
  SensorData dataAM2302B = lireCapteurDHT(AM2302B_PIN);
  afficherDonnees(dataAM2302B, "AM2302B");
  
  // Calcul de la moyenne si les deux lectures sont valides
  if(dataDHT22.isValid && dataAM2302B.isValid) {
    float tempMoyenne = (dataDHT22.temperature + dataAM2302B.temperature) / 2.0;
    float humMoyenne = (dataDHT22.humidity + dataAM2302B.humidity) / 2.0;
    
    Serial.println("--- MOYENNES ---");
    Serial.print("Température moyenne: ");
    Serial.print(tempMoyenne, 1);
    Serial.println(" °C");
    Serial.print("Humidité moyenne: ");
    Serial.print(humMoyenne, 1);
    Serial.println(" %");
    Serial.println();
  }
  
  // Attendre 2 secondes entre les lectures (DHT22 nécessite minimum 2s)
  delay(2000);
}